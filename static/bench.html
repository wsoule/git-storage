<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Git Storage Benchmarks</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", monospace;
      background: #0d1117;
      color: #e6edf3;
      padding: 2rem;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #f0f6fc;
    }

    .subtitle {
      color: #8b949e;
      font-size: 0.875rem;
      margin-bottom: 2rem;
    }

    .run-btn {
      background: #238636;
      color: #fff;
      border: none;
      padding: 0.6rem 1.4rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-bottom: 2rem;
      transition: background 0.2s;
    }

    .run-btn:hover { background: #2ea043; }
    .run-btn:disabled { background: #21262d; color: #8b949e; cursor: not-allowed; }

    .status {
      font-size: 0.85rem;
      color: #8b949e;
      margin-bottom: 2rem;
      min-height: 1.2rem;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: #f0f6fc;
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #21262d;
    }

    .size-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .tab {
      padding: 0.4rem 1rem;
      border-radius: 6px;
      border: 1px solid #30363d;
      background: #161b22;
      color: #8b949e;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.15s;
    }

    .tab.active {
      background: #1f6feb;
      border-color: #1f6feb;
      color: #fff;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .chart-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 1.25rem;
    }

    .chart-card h3 {
      font-size: 0.85rem;
      color: #8b949e;
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .chart-card canvas {
      max-height: 220px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th {
      text-align: left;
      padding: 0.6rem 1rem;
      color: #8b949e;
      border-bottom: 1px solid #21262d;
      font-weight: 500;
    }

    td {
      padding: 0.6rem 1rem;
      border-bottom: 1px solid #161b22;
      font-variant-numeric: tabular-nums;
    }

    tr:hover td { background: #161b22; }

    .backend-sqlite { color: #f78166; }
    .backend-badger { color: #79c0ff; }
    .backend-minio  { color: #56d364; }

    .history-item {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      font-size: 0.85rem;
      color: #8b949e;
      transition: border-color 0.15s;
    }

    .history-item:hover { border-color: #58a6ff; color: #e6edf3; }
    .history-item.active { border-color: #1f6feb; color: #e6edf3; }

    .empty { color: #8b949e; font-size: 0.85rem; padding: 1rem 0; }
  </style>
</head>
<body>

<h1>Git Storage Benchmarks</h1>
<p class="subtitle">Comparing SQLite, BadgerDB, and MinIO as git object stores</p>

<button class="run-btn" id="runBtn" onclick="runBenchmark()">Run Benchmarks</button>
<div class="status" id="status"></div>

<div id="results" style="display:none">
  <div class="section-title">Results</div>

  <div class="size-tabs" id="sizeTabs"></div>

  <div class="charts-grid">
    <div class="chart-card">
      <h3>Put — ops/sec (higher is better)</h3>
      <canvas id="chartPut"></canvas>
    </div>
    <div class="chart-card">
      <h3>Get — ops/sec (higher is better)</h3>
      <canvas id="chartGet"></canvas>
    </div>
    <div class="chart-card">
      <h3>Exists — ops/sec (higher is better)</h3>
      <canvas id="chartExists"></canvas>
    </div>
    <div class="chart-card">
      <h3>Concurrent Put — ops/sec (higher is better)</h3>
      <canvas id="chartConcurrent"></canvas>
    </div>
  </div>

  <div class="section-title">Latency Table (p50 / p99)</div>
  <table id="latencyTable">
    <thead>
      <tr>
        <th>Backend</th>
        <th>Operation</th>
        <th>p50</th>
        <th>p99</th>
        <th>ops/sec</th>
      </tr>
    </thead>
    <tbody id="latencyBody"></tbody>
  </table>
</div>

<div class="section-title">History</div>
<div id="historyList"><p class="empty">No runs yet.</p></div>

<script>
  const COLORS = {
    SQLite:   '#f78166',
    BadgerDB: '#79c0ff',
    MinIO:    '#56d364',
  }

  let charts = {}
  let currentRun = null
  let currentSizeIdx = 0
  let allRuns = []

  function fmt(ns) {
    if (ns < 1000) return ns.toFixed(0) + 'ns'
    if (ns < 1e6)  return (ns / 1000).toFixed(1) + 'µs'
    if (ns < 1e9)  return (ns / 1e6).toFixed(1) + 'ms'
    return (ns / 1e9).toFixed(2) + 's'
  }

  function fmtOps(ops) {
    if (ops >= 1000) return (ops / 1000).toFixed(1) + 'k'
    return ops.toFixed(1)
  }

  function backendClass(name) {
    return 'backend-' + name.toLowerCase().replace('db', '')
  }

  function makeChart(id, labels, datasets) {
    if (charts[id]) charts[id].destroy()
    const ctx = document.getElementById(id).getContext('2d')
    charts[id] = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
          y: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } }
        }
      }
    })
  }

  function renderRun(run, sizeIdx) {
    currentRun = run
    currentSizeIdx = sizeIdx

    // size tabs
    const tabsEl = document.getElementById('sizeTabs')
    tabsEl.innerHTML = ''
    const sizes = run.Backends[0].Results.map(r => r.Size.Name)
    sizes.forEach((name, i) => {
      const tab = document.createElement('div')
      tab.className = 'tab' + (i === sizeIdx ? ' active' : '')
      tab.textContent = name
      tab.onclick = () => renderRun(run, i)
      tabsEl.appendChild(tab)
    })

    const backends = run.Backends
    const labels = backends.map(b => b.Backend)

    function dataset(op) {
      return backends.map(b => {
        const r = b.Results[sizeIdx]
        return r ? r[op].OpsPerSec : 0
      })
    }

    function ds(op) {
      return [{
        data: dataset(op),
        backgroundColor: labels.map(l => COLORS[l] || '#8b949e'),
        borderRadius: 4,
      }]
    }

    makeChart('chartPut',        labels, ds('Put'))
    makeChart('chartGet',        labels, ds('Get'))
    makeChart('chartExists',     labels, ds('Exists'))
    makeChart('chartConcurrent', labels, ds('ConcurrentPut'))

    // latency table
    const tbody = document.getElementById('latencyBody')
    tbody.innerHTML = ''
    const ops = ['Put', 'Get', 'Exists', 'ConcurrentPut']
    backends.forEach(b => {
      const r = b.Results[sizeIdx]
      if (!r) return
      ops.forEach((op, i) => {
        const row = document.createElement('tr')
        row.innerHTML = `
          <td class="${backendClass(b.Backend)}">${i === 0 ? b.Backend : ''}</td>
          <td>${op}</td>
          <td>${fmt(r[op].P50)}</td>
          <td>${fmt(r[op].P99)}</td>
          <td>${fmtOps(r[op].OpsPerSec)}</td>
        `
        tbody.appendChild(row)
      })
    })

    document.getElementById('results').style.display = 'block'
  }

  function renderHistory() {
    const el = document.getElementById('historyList')
    if (allRuns.length === 0) {
      el.innerHTML = '<p class="empty">No runs yet.</p>'
      return
    }
    el.innerHTML = ''
    allRuns.slice().reverse().forEach((run, i) => {
      const div = document.createElement('div')
      div.className = 'history-item' + (i === 0 && currentRun === run ? ' active' : '')
      div.textContent = new Date(run.Timestamp).toLocaleString() +
        ' — ' + run.Backends.map(b => b.Backend).join(', ')
      div.onclick = () => renderRun(run, currentSizeIdx)
      el.appendChild(div)
    })
  }

  async function runBenchmark() {
    const btn = document.getElementById('runBtn')
    const status = document.getElementById('status')
    btn.disabled = true
    status.textContent = 'Running benchmarks… this takes ~30 seconds'

    try {
      const res = await fetch('/bench/run', { method: 'POST' })
      if (!res.ok) throw new Error('server error: ' + res.status)
      const run = await res.json()
      allRuns.push(run)
      renderRun(run, 0)
      renderHistory()
      status.textContent = 'Done — ' + new Date(run.Timestamp).toLocaleString()
    } catch (e) {
      status.textContent = 'Error: ' + e.message
    } finally {
      btn.disabled = false
    }
  }

  // load history on page load
  async function loadHistory() {
    try {
      const res = await fetch('/bench/history')
      allRuns = await res.json() || []
      if (allRuns.length > 0) {
        renderRun(allRuns[allRuns.length - 1], 0)
      }
      renderHistory()
    } catch(e) {}
  }

  loadHistory()
</script>
</body>
</html>
